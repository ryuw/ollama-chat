<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Local Ollama Chat</title>
<style>
body{font-family:system-ui, sans-serif;background:#f6f6f6;margin:0;display:flex;flex-direction:column;height:100vh;}
header{background:#111;color:#fff;padding:10px 16px;font-size:1.1rem;}
#chatLog{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px;}
.message{max-width:75%;padding:12px 16px;border-radius:8px;white-space:pre-wrap;line-height:1.4;position:relative;}
.user{align-self:flex-end;background:#0d6efd;color:#fff;border-bottom-right-radius:0;margin-right:2.2em;}
.assistant{align-self:flex-start;background:#e0e0e0;border-bottom-left-radius:0;margin-left:2.2em;}
.message.user::after,.message.assistant::before{position:absolute;top:50%;transform:translateY(-50%);font-size:1.4rem;}
.message.user::after{content:"üôÇ";right:-2em;}
.message.assistant::before{content:"ü¶ô";left:-2em;}
#inputBar{display:flex;padding:12px;background:#fff;gap:8px;}
#modelSelect{padding:8px;font-size:1rem;border:1px solid #ccc;border-radius:6px;}
#prompt{flex:1;padding:8px;font-size:1rem;border:1px solid #ccc;border-radius:6px;resize:vertical;min-height:2.5em;}
button{padding:8px 16px;font-size:1rem;border:none;border-radius:6px;background:#0d6efd;color:#fff;cursor:pointer;}
button:disabled{opacity:0.6;cursor:default;}
</style>
</head>
<body>
<header>ü¶ô Ollama Chat (Local)</header>
<main id="chatLog"></main>
<div id="inputBar">
<select id="modelSelect">
  <option value="gemma3:1b-it-qat">gemma3:1b-it-qat</option>
  <option value="llama3">llama3</option>
  <option value="phi3">phi3</option>
</select>
<textarea id="prompt" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ..." rows="2"></textarea>
<button id="sendBtn">ÈÄÅ‰ø°</button>
</div>

<script>
(() => {
  const endpoint = "http://localhost:11434/api/chat";

  const modelSelectEl = document.getElementById("modelSelect");

  const chatLogEl = document.getElementById("chatLog");
  const promptEl = document.getElementById("prompt");
  const sendBtn = document.getElementById("sendBtn");

  // Track whether we should auto scroll to the latest message
  let autoScroll = true;

  chatLogEl.addEventListener("scroll", () => {
    const atBottom = chatLogEl.scrollTop + chatLogEl.clientHeight >= chatLogEl.scrollHeight - 5;
    autoScroll = atBottom;
  });

  /** Convert basic markdown to HTML */
  function renderMarkdown(text){
    const escaped = text
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
    return escaped
      .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
      .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
      .replace(/(\*|_)([^\*_]+)\1/g, '<em>$2</em>')
      .replace(/`([^`]+)`/g, '<code>$1</code>')
      .replace(/\[([^\]]+)\]\(([^\)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
      .replace(/\n/g, '<br>');
  }

  /** Store conversation history */
  const history = [];

  function addMessage(text, role){
    const div = document.createElement("div");
    div.className = "message " + (role === "user" ? "user" : "assistant");
    div.innerHTML = renderMarkdown(text);
    chatLogEl.appendChild(div);
    if(autoScroll){
      chatLogEl.scrollTop = chatLogEl.scrollHeight;
    }
  }

  async function sendMessage(){
    const text = promptEl.value.trim();
    if(!text) return;
    promptEl.value = "";
    addMessage(text, "user");
    history.push({role:"user", content:text});

    sendBtn.disabled = true;

    let assistantText = "";
    // Pre-create assistant bubble for live streaming
    const assistantDiv = document.createElement("div");
    assistantDiv.className = "message assistant";
    chatLogEl.appendChild(assistantDiv);
    if(autoScroll){
      chatLogEl.scrollTop = chatLogEl.scrollHeight;
    }

    try {
      const res = await fetch(endpoint, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
          model: modelSelectEl.value,
          messages: history,
          stream: true
        })
      });
      if(!res.ok) throw new Error("HTTP " + res.status);

      const reader = res.body.getReader();
      const decoder = new TextDecoder("utf-8");
      let buffer = "";

      while(true){
        const {value, done} = await reader.read();
        if(done) break;
        buffer += decoder.decode(value, {stream:true});
        const lines = buffer.split("\n");
        buffer = lines.pop();  // last partial line
        for(const line of lines){
          if(!line.trim()) continue;
          const data = JSON.parse(line);
          if(data.message && data.message.content){
            assistantText += data.message.content;
            assistantDiv.innerHTML = renderMarkdown(assistantText);
            if(autoScroll){
              chatLogEl.scrollTop = chatLogEl.scrollHeight;
            }
          }
        }
      }

      if(buffer.trim()){
        const data = JSON.parse(buffer);
        if(data.message && data.message.content){
          assistantText += data.message.content;
          assistantDiv.innerHTML = renderMarkdown(assistantText);
        }
      }

      history.push({role:"assistant", content:assistantText});
    } catch(err) {
      assistantDiv.textContent = "[Error] " + err.message;
    } finally {
      sendBtn.disabled = false;
      promptEl.focus();
    }
  }

  sendBtn.addEventListener("click", sendMessage);
  promptEl.addEventListener("keydown", e => {
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      sendMessage();
    }
  });

})();
</script>
</body>
</html>
