<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Local Ollama Chat</title>
<style>
body{font-family:system-ui, sans-serif;background:#f6f6f6;margin:0;display:flex;flex-direction:column;height:100vh;}
header{background:#111;color:#fff;padding:10px 16px;font-size:1.1rem;}
#chatLog{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px;}
.message{max-width:75%;padding:12px 16px;border-radius:8px;white-space:pre-wrap;line-height:1.4;}
.user{align-self:flex-end;background:#0d6efd;color:#fff;border-bottom-right-radius:0;}
.assistant{align-self:flex-start;background:#e0e0e0;border-bottom-left-radius:0;}
#inputBar{display:flex;padding:12px;background:#fff;gap:8px;}
#prompt{flex:1;padding:8px;font-size:1rem;border:1px solid #ccc;border-radius:6px;}
button{padding:8px 16px;font-size:1rem;border:none;border-radius:6px;background:#0d6efd;color:#fff;cursor:pointer;}
button:disabled{opacity:0.6;cursor:default;}
</style>
</head>
<body>
<header>ü¶ô Ollama Chat (Local)</header>
<main id="chatLog"></main>
<div id="inputBar">
<input id="prompt" type="text" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ..." autocomplete="off">
<button id="sendBtn">ÈÄÅ‰ø°</button>
</div>

<script>
(() => {
  const model = "gemma3:1b";                  // „Åì„Åì„ÇíÂ•Ω„Åø„ÅÆ„É¢„Éá„É´Âêç„Å´Â§âÊõ¥
  const endpoint = "http://localhost:11434/api/chat";

  const chatLogEl = document.getElementById("chatLog");
  const promptEl = document.getElementById("prompt");
  const sendBtn = document.getElementById("sendBtn");

  /** Store conversation history */
  const history = [];

  function addMessage(text, role){
    const div = document.createElement("div");
    div.className = "message " + (role === "user" ? "user" : "assistant");
    div.textContent = text;
    chatLogEl.appendChild(div);
    chatLogEl.scrollTop = chatLogEl.scrollHeight;
  }

  async function sendMessage(){
    const text = promptEl.value.trim();
    if(!text) return;
    promptEl.value = "";
    addMessage(text, "user");
    history.push({role:"user", content:text});

    sendBtn.disabled = true;

    let assistantText = "";
    // Pre‚Äëcreate assistant bubble for live streaming
    const assistantDiv = document.createElement("div");
    assistantDiv.className = "message assistant";
    chatLogEl.appendChild(assistantDiv);
    chatLogEl.scrollTop = chatLogEl.scrollHeight;

    const res = await fetch(endpoint, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        model,
        messages: history,
        stream: true
      })
    });

    const reader = res.body.getReader();
    const decoder = new TextDecoder("utf-8");
    let buffer = "";

    while(true){
      const {value, done} = await reader.read();
      if(done) break;
      buffer += decoder.decode(value, {stream:true});
      const lines = buffer.split("\n");
      buffer = lines.pop();  // last partial line
      for(const line of lines){
        if(!line.trim()) continue;
        const data = JSON.parse(line);
        if(data.message && data.message.content){
          assistantText += data.message.content;
          assistantDiv.textContent = assistantText;
          chatLogEl.scrollTop = chatLogEl.scrollHeight;
        }
      }
    }
    history.push({role:"assistant", content:assistantText});
    sendBtn.disabled = false;
    promptEl.focus();
  }

  sendBtn.addEventListener("click", sendMessage);
  promptEl.addEventListener("keydown", e => {
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      sendMessage();
    }
  });

})();
</script>
</body>
</html>
